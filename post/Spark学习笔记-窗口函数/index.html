<!DOCTYPE html>
<html lang=zh-CN>
  <head><meta name="generator" content="Hexo 3.9.0">
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">
  <meta http-equiv="X-UA-Compatible" content="ie=edge">
  <meta name="description" content>
  <meta name="keywords" content>
  
    <link rel="icon" href="/favicon.ico">
  
    
  <title>Spark学习笔记-窗口函数 | 努力，奋斗</title>
  <link rel="stylesheet" href="/style.css">
  <link rel="stylesheet" href="/lib/jquery.fancybox.min.css">
  <link href="https://maxcdn.bootstrapcdn.com/font-awesome/4.7.0/css/font-awesome.min.css">
</head>

<body>
  <header>
  <div class="header-container">
    <a class='logo' href="/">
      <span>努力，奋斗</span>
    </a>
    <ul class="right-header">
      
        <li class="nav-item">
          
            <a href="/" class="item-link">首页</a>
          
        </li>
      
        <li class="nav-item">
          
            <a href="/about" class="item-link">关于</a>
          
        </li>
      
        <li class="nav-item">
          
            <a href="/archives" class="item-link">归档</a>
          
        </li>
      
        <li class="nav-item">
          
            <a href="/tags" class="item-link">标签</a>
          
        </li>
      
    </ul>
  </div>
</header>

  <main id='post'>
  <div class="content">
    <article>
        <section class="content markdown-body">
          <h1>Spark学习笔记-窗口函数</h1>
          <div class='post-meta'>
            <i class="fa fa-calendar" aria-hidden="true"></i> <time>2019年03月12日</time>
            
              | <i class="fa fa-folder-open-o" aria-hidden="true"></i> 
  <div class="article-category">
    <a class="article-category-link" href="/categories/Spark/">Spark</a>
  </div>



            
            
              | 
                  <i class="fa fa-tag" aria-hidden="true"></i>
                
               
  <a href="/tags/#Spark学习" class='tag'>Spark学习</a>


            
          </div>
          <figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="keyword">from</span> pyspark.sql <span class="keyword">import</span> SparkSession</span><br><span class="line"><span class="keyword">from</span> pyspark.sql.functions <span class="keyword">import</span> *</span><br><span class="line"><span class="keyword">from</span> pyspark.sql <span class="keyword">import</span> Window</span><br><span class="line"><span class="keyword">from</span> pyspark.sql.types <span class="keyword">import</span> StructType, StringType, StructField, IntegerType</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">schema = StructType([</span><br><span class="line">    StructField(<span class="string">'shop_id'</span>, StringType()),</span><br><span class="line">    StructField(<span class="string">'date'</span>, StringType()),</span><br><span class="line">    StructField(<span class="string">'amount'</span>, IntegerType())</span><br><span class="line">])</span><br></pre></td></tr></table></figure>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line">spark = SparkSession \</span><br><span class="line">        .builder \</span><br><span class="line">        .master(<span class="string">'local[*]'</span>) \</span><br><span class="line">        .enableHiveSupport() \</span><br><span class="line">        .getOrCreate()</span><br></pre></td></tr></table></figure>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line">data = [</span><br><span class="line">        &#123;<span class="string">'shop_id'</span>: <span class="string">'10006'</span>, <span class="string">'date'</span>: <span class="string">'201501120030'</span>, <span class="string">'amount'</span>: <span class="number">2313</span>&#125;,</span><br><span class="line">        &#123;<span class="string">'shop_id'</span>: <span class="string">'10006'</span>, <span class="string">'date'</span>: <span class="string">'201501120100'</span>, <span class="string">'amount'</span>: <span class="number">23112</span>&#125;,</span><br><span class="line">        &#123;<span class="string">'shop_id'</span>: <span class="string">'10006'</span>, <span class="string">'date'</span>: <span class="string">'201501120130'</span>, <span class="string">'amount'</span>: <span class="number">23112</span>&#125;,</span><br><span class="line">        &#123;<span class="string">'shop_id'</span>: <span class="string">'10006'</span>, <span class="string">'date'</span>: <span class="string">'201501120200'</span>, <span class="string">'amount'</span>: <span class="number">24234</span>&#125;,</span><br><span class="line">        &#123;<span class="string">'shop_id'</span>: <span class="string">'10006'</span>, <span class="string">'date'</span>: <span class="string">'201501120230'</span>, <span class="string">'amount'</span>: <span class="number">132</span>&#125;,</span><br><span class="line">        &#123;<span class="string">'shop_id'</span>: <span class="string">'10006'</span>, <span class="string">'date'</span>: <span class="string">'201501120300'</span>, <span class="string">'amount'</span>: <span class="number">31232</span>&#125;,</span><br><span class="line">        &#123;<span class="string">'shop_id'</span>: <span class="string">'10006'</span>, <span class="string">'date'</span>: <span class="string">'201501120330'</span>, <span class="string">'amount'</span>: <span class="number">221313</span>&#125;,</span><br><span class="line">        &#123;<span class="string">'shop_id'</span>: <span class="string">'10006'</span>, <span class="string">'date'</span>: <span class="string">'201501120400'</span>, <span class="string">'amount'</span>: <span class="number">2134</span>&#125;,</span><br><span class="line">        &#123;<span class="string">'shop_id'</span>: <span class="string">'10006'</span>, <span class="string">'date'</span>: <span class="string">'201501120430'</span>, <span class="string">'amount'</span>: <span class="number">2231</span>&#125;,</span><br><span class="line">        &#123;<span class="string">'shop_id'</span>: <span class="string">'10006'</span>, <span class="string">'date'</span>: <span class="string">'201501120500'</span>, <span class="string">'amount'</span>: <span class="number">2234</span>&#125;,</span><br><span class="line">        &#123;<span class="string">'shop_id'</span>: <span class="string">'10006'</span>, <span class="string">'date'</span>: <span class="string">'201501120530'</span>, <span class="string">'amount'</span>: <span class="number">2234</span>&#125;,</span><br><span class="line">        &#123;<span class="string">'shop_id'</span>: <span class="string">'10006'</span>, <span class="string">'date'</span>: <span class="string">'201501120600'</span>, <span class="string">'amount'</span>: <span class="number">231635</span>&#125;,</span><br><span class="line">        &#123;<span class="string">'shop_id'</span>: <span class="string">'10006'</span>, <span class="string">'date'</span>: <span class="string">'201501120630'</span>, <span class="string">'amount'</span>: <span class="number">2536</span>&#125;,</span><br><span class="line">        &#123;<span class="string">'shop_id'</span>: <span class="string">'10006'</span>, <span class="string">'date'</span>: <span class="string">'201501120700'</span>, <span class="string">'amount'</span>: <span class="number">425432</span>&#125;,</span><br><span class="line">        &#123;<span class="string">'shop_id'</span>: <span class="string">'10006'</span>, <span class="string">'date'</span>: <span class="string">'201501120730'</span>, <span class="string">'amount'</span>: <span class="number">36362</span>&#125;,</span><br><span class="line">        &#123;<span class="string">'shop_id'</span>: <span class="string">'10006'</span>, <span class="string">'date'</span>: <span class="string">'201501120800'</span>, <span class="string">'amount'</span>: <span class="number">5645622</span>&#125;,</span><br><span class="line">        &#123;<span class="string">'shop_id'</span>: <span class="string">'10006'</span>, <span class="string">'date'</span>: <span class="string">'201501120830'</span>, <span class="string">'amount'</span>: <span class="number">34532</span>&#125;,</span><br><span class="line">        &#123;<span class="string">'shop_id'</span>: <span class="string">'10006'</span>, <span class="string">'date'</span>: <span class="string">'201501120900'</span>, <span class="string">'amount'</span>: <span class="number">366642</span>&#125;,</span><br><span class="line">        &#123;<span class="string">'shop_id'</span>: <span class="string">'10006'</span>, <span class="string">'date'</span>: <span class="string">'201501120930'</span>, <span class="string">'amount'</span>: <span class="number">74632</span>&#125;,</span><br><span class="line">        &#123;<span class="string">'shop_id'</span>: <span class="string">'10006'</span>, <span class="string">'date'</span>: <span class="string">'201501121000'</span>, <span class="string">'amount'</span>: <span class="number">63562</span>&#125;,</span><br><span class="line">        &#123;<span class="string">'shop_id'</span>: <span class="string">'10006'</span>, <span class="string">'date'</span>: <span class="string">'201501121030'</span>, <span class="string">'amount'</span>: <span class="number">26353</span>&#125;,</span><br><span class="line">        &#123;<span class="string">'shop_id'</span>: <span class="string">'10006'</span>, <span class="string">'date'</span>: <span class="string">'201501121100'</span>, <span class="string">'amount'</span>: <span class="number">2353</span>&#125;,</span><br><span class="line">        &#123;<span class="string">'shop_id'</span>: <span class="string">'10006'</span>, <span class="string">'date'</span>: <span class="string">'201501121130'</span>, <span class="string">'amount'</span>: <span class="number">26352</span>&#125;,</span><br><span class="line">        &#123;<span class="string">'shop_id'</span>: <span class="string">'10006'</span>, <span class="string">'date'</span>: <span class="string">'201501121200'</span>, <span class="string">'amount'</span>: <span class="number">254352</span>&#125;,</span><br><span class="line">        &#123;<span class="string">'shop_id'</span>: <span class="string">'10006'</span>, <span class="string">'date'</span>: <span class="string">'201501121230'</span>, <span class="string">'amount'</span>: <span class="number">534236</span>&#125;,</span><br><span class="line">        &#123;<span class="string">'shop_id'</span>: <span class="string">'10006'</span>, <span class="string">'date'</span>: <span class="string">'201501121300'</span>, <span class="string">'amount'</span>: <span class="number">35432</span>&#125;,</span><br><span class="line">        &#123;<span class="string">'shop_id'</span>: <span class="string">'10006'</span>, <span class="string">'date'</span>: <span class="string">'201501121330'</span>, <span class="string">'amount'</span>: <span class="number">353462</span>&#125;,</span><br><span class="line">        &#123;<span class="string">'shop_id'</span>: <span class="string">'10006'</span>, <span class="string">'date'</span>: <span class="string">'201501121400'</span>, <span class="string">'amount'</span>: <span class="number">64562</span>&#125;,</span><br><span class="line">        &#123;<span class="string">'shop_id'</span>: <span class="string">'10006'</span>, <span class="string">'date'</span>: <span class="string">'201501121430'</span>, <span class="string">'amount'</span>: <span class="number">652562</span>&#125;,</span><br><span class="line">        &#123;<span class="string">'shop_id'</span>: <span class="string">'10006'</span>, <span class="string">'date'</span>: <span class="string">'201501121500'</span>, <span class="string">'amount'</span>: <span class="number">2456</span>&#125;,</span><br><span class="line">        &#123;<span class="string">'shop_id'</span>: <span class="string">'10006'</span>, <span class="string">'date'</span>: <span class="string">'201501121530'</span>, <span class="string">'amount'</span>: <span class="number">6422</span>&#125;,</span><br><span class="line">        &#123;<span class="string">'shop_id'</span>: <span class="string">'10006'</span>, <span class="string">'date'</span>: <span class="string">'201501121600'</span>, <span class="string">'amount'</span>: <span class="number">422</span>&#125;,</span><br><span class="line">        &#123;<span class="string">'shop_id'</span>: <span class="string">'10006'</span>, <span class="string">'date'</span>: <span class="string">'201501121630'</span>, <span class="string">'amount'</span>: <span class="number">27843</span>&#125;,</span><br><span class="line">        &#123;<span class="string">'shop_id'</span>: <span class="string">'10006'</span>, <span class="string">'date'</span>: <span class="string">'201501121700'</span>, <span class="string">'amount'</span>: <span class="number">2362</span>&#125;,</span><br><span class="line">        &#123;<span class="string">'shop_id'</span>: <span class="string">'10006'</span>, <span class="string">'date'</span>: <span class="string">'201501121730'</span>, <span class="string">'amount'</span>: <span class="number">24683</span>&#125;,</span><br><span class="line">        &#123;<span class="string">'shop_id'</span>: <span class="string">'10006'</span>, <span class="string">'date'</span>: <span class="string">'201501121800'</span>, <span class="string">'amount'</span>: <span class="number">4532</span>&#125;,</span><br><span class="line">        &#123;<span class="string">'shop_id'</span>: <span class="string">'10006'</span>, <span class="string">'date'</span>: <span class="string">'201501121830'</span>, <span class="string">'amount'</span>: <span class="number">5342</span>&#125;,</span><br><span class="line">        &#123;<span class="string">'shop_id'</span>: <span class="string">'10006'</span>, <span class="string">'date'</span>: <span class="string">'201501121900'</span>, <span class="string">'amount'</span>: <span class="number">65642</span>&#125;,</span><br><span class="line">        &#123;<span class="string">'shop_id'</span>: <span class="string">'10006'</span>, <span class="string">'date'</span>: <span class="string">'201501121930'</span>, <span class="string">'amount'</span>: <span class="number">2534</span>&#125;,</span><br><span class="line">        &#123;<span class="string">'shop_id'</span>: <span class="string">'10006'</span>, <span class="string">'date'</span>: <span class="string">'201501122000'</span>, <span class="string">'amount'</span>: <span class="number">25376</span>&#125;,</span><br><span class="line">        &#123;<span class="string">'shop_id'</span>: <span class="string">'10006'</span>, <span class="string">'date'</span>: <span class="string">'201501122030'</span>, <span class="string">'amount'</span>: <span class="number">242443</span>&#125;,</span><br><span class="line">        &#123;<span class="string">'shop_id'</span>: <span class="string">'10006'</span>, <span class="string">'date'</span>: <span class="string">'201501122100'</span>, <span class="string">'amount'</span>: <span class="number">2344562</span>&#125;,</span><br><span class="line">        &#123;<span class="string">'shop_id'</span>: <span class="string">'10006'</span>, <span class="string">'date'</span>: <span class="string">'201501122130'</span>, <span class="string">'amount'</span>: <span class="number">5462</span>&#125;,</span><br><span class="line">        &#123;<span class="string">'shop_id'</span>: <span class="string">'10006'</span>, <span class="string">'date'</span>: <span class="string">'201501122200'</span>, <span class="string">'amount'</span>: <span class="number">2535</span>&#125;,</span><br><span class="line">        &#123;<span class="string">'shop_id'</span>: <span class="string">'10006'</span>, <span class="string">'date'</span>: <span class="string">'201501122230'</span>, <span class="string">'amount'</span>: <span class="number">242546</span>&#125;,</span><br><span class="line">        &#123;<span class="string">'shop_id'</span>: <span class="string">'10006'</span>, <span class="string">'date'</span>: <span class="string">'201501122300'</span>, <span class="string">'amount'</span>: <span class="number">6542</span>&#125;,</span><br><span class="line">        &#123;<span class="string">'shop_id'</span>: <span class="string">'10006'</span>, <span class="string">'date'</span>: <span class="string">'201501122330'</span>, <span class="string">'amount'</span>: <span class="number">2546</span>&#125;,</span><br><span class="line">        &#123;<span class="string">'shop_id'</span>: <span class="string">'10006'</span>, <span class="string">'date'</span>: <span class="string">'201501130000'</span>, <span class="string">'amount'</span>: <span class="number">45245</span>&#125;,</span><br><span class="line">    ]</span><br></pre></td></tr></table></figure>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line">df = spark.createDataFrame(data, schema)</span><br></pre></td></tr></table></figure>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line">df.printSchema()</span><br></pre></td></tr></table></figure>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">root</span><br><span class="line"> |-- shop_id: string (nullable = true)</span><br><span class="line"> |-- date: string (nullable = true)</span><br><span class="line"> |-- amount: integer (nullable = true)</span><br></pre></td></tr></table></figure>
<p>关于子窗口：</p>
<p>子窗口需要指定一个边界，有以下两种方式：</p>
<ul>
<li>ROWS between CURRENT ROW | UNBOUNDED PRECEDING | [num] PRECEDING AND  UNBOUNDED FOLLOWING | [num] FOLLOWING| CURRENT ROW</li>
<li>RANGE between [num] PRECEDING  AND [num] FOLLOWING</li>
</ul>
<p>窗口的含义<br><img src="https://ws4.sinaimg.cn/large/006tKfTcly1g10643qf18j30de06h3yq.jpg" alt></p>
<p>ROWS是物理窗口，从行数上控制窗口的尺寸的；<br>RANGE是逻辑窗口，从列值上控制窗口的尺寸</p>
<p>通常会结合order by子句使用，如果在order by子句后面没有指定窗口子句，则默认为：rows between unbounded preceding and current row</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">spark中关于Window函数的学习</span><br><span class="line"></span><br><span class="line">在spark中涉及Window函数的主要有以下两个类和一个Column的方法</span><br><span class="line">pyspark.sql.column.Column#over   在窗口上应用某一种分析函数</span><br><span class="line">pyspark.sql.window.Window        创建WindowSpec的工具类</span><br><span class="line">    pyspark.sql.window.Window.unboundedPreceding</span><br><span class="line">    pyspark.sql.window.Window.unboundedFollowing</span><br><span class="line">    pyspark.sql.window.Window.currentRow</span><br><span class="line">    pyspark.sql.window.Window#partitionBy</span><br><span class="line">    pyspark.sql.window.Window#orderBy</span><br><span class="line">    pyspark.sql.window.Window#rowsBetween(start, end)</span><br><span class="line">    pyspark.sql.window.Window#rangeBetween(start, end)</span><br><span class="line">pyspark.sql.window.WindowSpec    窗口的规范</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">pyspark.sql.window.Window#rowsBetween(start, end)</span><br><span class="line">定义窗口的边界，[start, end]，在边界处是闭区间</span><br><span class="line">start和end都是相对于当前row的相对位置，例如：</span><br><span class="line">- 0：当前row</span><br><span class="line">- -1：当前行的前1row</span><br><span class="line">- 5：当前行的后5row</span><br><span class="line">- (-1, 5)：窗口的范围为，当前row+当前行的前1row+当前行的后5row = 7rows</span><br></pre></td></tr></table></figure>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line">df.show(<span class="number">50</span>)</span><br></pre></td></tr></table></figure>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">+-------+------------+-------+</span><br><span class="line">|shop_id|        date| amount|</span><br><span class="line">+-------+------------+-------+</span><br><span class="line">|  10006|201501120030|   2313|</span><br><span class="line">|  10006|201501120100|  23112|</span><br><span class="line">|  10006|201501120130|   2342|</span><br><span class="line">|  10006|201501120200|  24234|</span><br><span class="line">|  10006|201501120230|    132|</span><br><span class="line">|  10006|201501120300|  31232|</span><br><span class="line">|  10006|201501120330| 221313|</span><br><span class="line">|  10006|201501120400|   2134|</span><br><span class="line">|  10006|201501120430|   2231|</span><br><span class="line">|  10006|201501120500|   2234|</span><br><span class="line">|  10006|201501120530|   2234|</span><br><span class="line">|  10006|201501120600| 231635|</span><br><span class="line">|  10006|201501120630|   2536|</span><br><span class="line">|  10006|201501120700| 425432|</span><br><span class="line">|  10006|201501120730|  36362|</span><br><span class="line">|  10006|201501120800|5645622|</span><br><span class="line">|  10006|201501120830|  34532|</span><br><span class="line">|  10006|201501120900| 366642|</span><br><span class="line">|  10006|201501120930|  74632|</span><br><span class="line">|  10006|201501121000|  63562|</span><br><span class="line">|  10006|201501121030|  26353|</span><br><span class="line">|  10006|201501121100|   2353|</span><br><span class="line">|  10006|201501121130|  26352|</span><br><span class="line">|  10006|201501121200| 254352|</span><br><span class="line">|  10006|201501121230| 534236|</span><br><span class="line">|  10006|201501121300|  35432|</span><br><span class="line">|  10006|201501121330| 353462|</span><br><span class="line">|  10006|201501121400|  64562|</span><br><span class="line">|  10006|201501121430| 652562|</span><br><span class="line">|  10006|201501121500|   2456|</span><br><span class="line">|  10006|201501121530|   6422|</span><br><span class="line">|  10006|201501121600|    422|</span><br><span class="line">|  10006|201501121630|  27843|</span><br><span class="line">|  10006|201501121700|   2362|</span><br><span class="line">|  10006|201501121730|  24683|</span><br><span class="line">|  10006|201501121800|   4532|</span><br><span class="line">|  10006|201501121830|   5342|</span><br><span class="line">|  10006|201501121900|  65642|</span><br><span class="line">|  10006|201501121930|   2534|</span><br><span class="line">|  10006|201501122000|  25376|</span><br><span class="line">|  10006|201501122030| 242443|</span><br><span class="line">|  10006|201501122100|2344562|</span><br><span class="line">|  10006|201501122130|   5462|</span><br><span class="line">|  10006|201501122200|   2535|</span><br><span class="line">|  10006|201501122230| 242546|</span><br><span class="line">|  10006|201501122300|   6542|</span><br><span class="line">|  10006|201501122330|   2546|</span><br><span class="line">|  10006|201501130000|  45245|</span><br><span class="line">+-------+------------+-------+</span><br></pre></td></tr></table></figure>
<p>1.统计截止到当前时间段的店铺累计销售金额</p>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line">df.withColumn(</span><br><span class="line">    <span class="string">'t_amount'</span>,</span><br><span class="line">    sum(<span class="string">'amount'</span>).over(Window.partitionBy(<span class="string">'shop_id'</span>).orderBy(asc(<span class="string">'date'</span>)))</span><br><span class="line">).select(</span><br><span class="line">    <span class="string">'shop_id'</span>, <span class="string">'date'</span>, <span class="string">'t_amount'</span></span><br><span class="line">).show(<span class="number">50</span>, truncate=<span class="literal">False</span>)</span><br></pre></td></tr></table></figure>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">+-------+------------+--------+</span><br><span class="line">|shop_id|date        |t_amount|</span><br><span class="line">+-------+------------+--------+</span><br><span class="line">|10006  |201501120030|2313    |</span><br><span class="line">|10006  |201501120100|25425   |</span><br><span class="line">|10006  |201501120130|27767   |</span><br><span class="line">|10006  |201501120200|52001   |</span><br><span class="line">|10006  |201501120230|52133   |</span><br><span class="line">|10006  |201501120300|83365   |</span><br><span class="line">|10006  |201501120330|304678  |</span><br><span class="line">|10006  |201501120400|306812  |</span><br><span class="line">|10006  |201501120430|309043  |</span><br><span class="line">|10006  |201501120500|311277  |</span><br><span class="line">|10006  |201501120530|313511  |</span><br><span class="line">|10006  |201501120600|545146  |</span><br><span class="line">|10006  |201501120630|547682  |</span><br><span class="line">|10006  |201501120700|973114  |</span><br><span class="line">|10006  |201501120730|1009476 |</span><br><span class="line">|10006  |201501120800|6655098 |</span><br><span class="line">|10006  |201501120830|6689630 |</span><br><span class="line">|10006  |201501120900|7056272 |</span><br><span class="line">|10006  |201501120930|7130904 |</span><br><span class="line">|10006  |201501121000|7194466 |</span><br><span class="line">|10006  |201501121030|7220819 |</span><br><span class="line">|10006  |201501121100|7223172 |</span><br><span class="line">|10006  |201501121130|7249524 |</span><br><span class="line">|10006  |201501121200|7503876 |</span><br><span class="line">|10006  |201501121230|8038112 |</span><br><span class="line">|10006  |201501121300|8073544 |</span><br><span class="line">|10006  |201501121330|8427006 |</span><br><span class="line">|10006  |201501121400|8491568 |</span><br><span class="line">|10006  |201501121430|9144130 |</span><br><span class="line">|10006  |201501121500|9146586 |</span><br><span class="line">|10006  |201501121530|9153008 |</span><br><span class="line">|10006  |201501121600|9153430 |</span><br><span class="line">|10006  |201501121630|9181273 |</span><br><span class="line">|10006  |201501121700|9183635 |</span><br><span class="line">|10006  |201501121730|9208318 |</span><br><span class="line">|10006  |201501121800|9212850 |</span><br><span class="line">|10006  |201501121830|9218192 |</span><br><span class="line">|10006  |201501121900|9283834 |</span><br><span class="line">|10006  |201501121930|9286368 |</span><br><span class="line">|10006  |201501122000|9311744 |</span><br><span class="line">|10006  |201501122030|9554187 |</span><br><span class="line">|10006  |201501122100|11898749|</span><br><span class="line">|10006  |201501122130|11904211|</span><br><span class="line">|10006  |201501122200|11906746|</span><br><span class="line">|10006  |201501122230|12149292|</span><br><span class="line">|10006  |201501122300|12155834|</span><br><span class="line">|10006  |201501122330|12158380|</span><br><span class="line">|10006  |201501130000|12203625|</span><br><span class="line">+-------+------------+--------+</span><br></pre></td></tr></table></figure>
<p>分析：<br>根据shop_id分组，根据date正序排列，由于orderBy后面没有追加rowsBetween()，则默认的rowsBetween为：[Window.unboundedPreceding，Window.currentRow]。即会统计根据date排序后，从第一行计算到当前行，从而达到了<code>统计截止到当前时间段的店铺累计销售金额</code>的效果</p>
<p>2.统计每个时间段的销售占比</p>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line">df.withColumn(</span><br><span class="line">    <span class="string">'t_amount'</span>,</span><br><span class="line">    col(<span class="string">'amount'</span>)/sum(<span class="string">'amount'</span>).over(Window.partitionBy(<span class="string">'shop_id'</span>))</span><br><span class="line">).select(</span><br><span class="line">    <span class="string">'shop_id'</span>, <span class="string">'date'</span>, <span class="string">'amount'</span>,<span class="string">'t_amount'</span></span><br><span class="line">).show(<span class="number">50</span>, truncate=<span class="literal">False</span>)</span><br></pre></td></tr></table></figure>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">+-------+------------+-------+---------------------+</span><br><span class="line">|shop_id|date        |amount |t_amount             |</span><br><span class="line">+-------+------------+-------+---------------------+</span><br><span class="line">|10006  |201501120030|2313   |1.8953384752481333E-4|</span><br><span class="line">|10006  |201501120100|23112  |0.0018938635036720647|</span><br><span class="line">|10006  |201501120130|2342   |1.919101906195905E-4 |</span><br><span class="line">|10006  |201501120200|24234  |0.0019858033985803397|</span><br><span class="line">|10006  |201501120230|132    |1.0816458224502965E-5|</span><br><span class="line">|10006  |201501120300|31232  |0.002559239570209671 |</span><br><span class="line">|10006  |201501120330|221313 |0.01813502135635928  |</span><br><span class="line">|10006  |201501120400|2134   |1.748660746294646E-4 |</span><br><span class="line">|10006  |201501120430|2231   |1.8281453256716753E-4|</span><br><span class="line">|10006  |201501120500|2234   |1.8306036116317898E-4|</span><br><span class="line">|10006  |201501120530|2234   |1.8306036116317898E-4|</span><br><span class="line">|10006  |201501120600|231635 |0.018980835612369275 |</span><br><span class="line">|10006  |201501120630|2536   |2.0780710649499637E-4|</span><br><span class="line">|10006  |201501120700|425432 |0.03486111708611171  |</span><br><span class="line">|10006  |201501120730|36362  |0.0029796064693892186|</span><br><span class="line">|10006  |201501120800|5645622|0.46261844329041574  |</span><br><span class="line">|10006  |201501120830|34532  |0.0028296510258222453|</span><br><span class="line">|10006  |201501120900|366642 |0.030043696032941034 |</span><br><span class="line">|10006  |201501120930|74632  |0.006115559925841707 |</span><br><span class="line">|10006  |201501121000|63562  |0.005208452406559526 |</span><br><span class="line">|10006  |201501121030|26353  |0.0021594403302297475|</span><br><span class="line">|10006  |201501121100|2353   |1.9281156213829908E-4|</span><br><span class="line">|10006  |201501121130|26352  |0.00215935838736441  |</span><br><span class="line">|10006  |201501121200|254352 |0.02084233168423317  |</span><br><span class="line">|10006  |201501121230|534236 |0.04377682860625429  |</span><br><span class="line">|10006  |201501121300|35432  |0.0029033996046256747|</span><br><span class="line">|10006  |201501121330|353462 |0.028963689067797477 |</span><br><span class="line">|10006  |201501121400|64562  |0.00529039527189667  |</span><br><span class="line">|10006  |201501121430|652562 |0.05347280009013715  |</span><br><span class="line">|10006  |201501121500|2456   |2.0125167726802487E-4|</span><br><span class="line">|10006  |201501121530|6422   |5.262370811951367E-4 |</span><br><span class="line">|10006  |201501121600|422    |3.457988917227463E-5 |</span><br><span class="line">|10006  |201501121630|27843  |0.002281535199582091 |</span><br><span class="line">|10006  |201501121700|2362   |1.9354904792633337E-4|</span><br><span class="line">|10006  |201501121730|24683  |0.0020225957451167173|</span><br><span class="line">|10006  |201501121800|4532   |3.7136506570793515E-4|</span><br><span class="line">|10006  |201501121830|5342   |4.377387866310215E-4 |</span><br><span class="line">|10006  |201501121900|65642  |0.0053788935664607854|</span><br><span class="line">|10006  |201501121930|2534   |2.0764322076432208E-4|</span><br><span class="line">|10006  |201501122000|25376  |0.002079382150795358 |</span><br><span class="line">|10006  |201501122030|242443 |0.019866474100933125 |</span><br><span class="line">|10006  |201501122100|2344562|0.19212012824058425  |</span><br><span class="line">|10006  |201501122130|5462   |4.4757193047147874E-4|</span><br><span class="line">|10006  |201501122200|2535   |2.0772516362965921E-4|</span><br><span class="line">|10006  |201501122230|242546 |0.01987491421606285  |</span><br><span class="line">|10006  |201501122300|6542   |5.360702250355939E-4 |</span><br><span class="line">|10006  |201501122330|2546   |2.086265351483678E-4 |</span><br><span class="line">|10006  |201501130000|45245  |0.0037075049421790656|</span><br><span class="line">+-------+------------+-------+---------------------+</span><br></pre></td></tr></table></figure>
<p>分析：<br>根据shop_id分组，不排序，窗口大小默认就是整个分组。</p>
<p>3.找出2点的销售金额及前半小时的销售金额和后1个小时的销售金额</p>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line">df.withColumn(</span><br><span class="line">    <span class="string">'pre_half_hour'</span>,</span><br><span class="line">    lag(<span class="string">'date'</span>, <span class="number">1</span>).over(Window.partitionBy(<span class="string">'shop_id'</span>).orderBy(asc(<span class="string">'date'</span>)))</span><br><span class="line">).withColumn(</span><br><span class="line">    <span class="string">'pre_half_hour_amount'</span>,</span><br><span class="line">    lag(<span class="string">'amount'</span>, <span class="number">1</span>).over(Window.partitionBy(<span class="string">'shop_id'</span>).orderBy(asc(<span class="string">'date'</span>)))</span><br><span class="line">).withColumn(</span><br><span class="line">    <span class="string">'follow_one_hour'</span>,</span><br><span class="line">    lead(<span class="string">'date'</span>, <span class="number">2</span>).over(Window.partitionBy(<span class="string">'shop_id'</span>).orderBy(asc(<span class="string">'date'</span>)))</span><br><span class="line">).withColumn(</span><br><span class="line">    <span class="string">'follow_one_hour_amount'</span>,</span><br><span class="line">    lead(<span class="string">'amount'</span>, <span class="number">2</span>).over(Window.partitionBy(<span class="string">'shop_id'</span>).orderBy(asc(<span class="string">'date'</span>)))</span><br><span class="line">).filter(</span><br><span class="line">    col(<span class="string">'date'</span>) == <span class="string">'201501120200'</span></span><br><span class="line">).select(</span><br><span class="line">    <span class="string">'shop_id'</span>, <span class="string">'date'</span>, <span class="string">'amount'</span>,<span class="string">'pre_half_hour'</span>, <span class="string">'pre_half_hour_amount'</span>, <span class="string">'follow_one_hour'</span>, <span class="string">'follow_one_hour_amount'</span></span><br><span class="line">).show(truncate=<span class="literal">False</span>)</span><br></pre></td></tr></table></figure>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">+-------+------------+------+-------------+--------------------+---------------+----------------------+</span><br><span class="line">|shop_id|date        |amount|pre_half_hour|pre_half_hour_amount|follow_one_hour|follow_one_hour_amount|</span><br><span class="line">+-------+------------+------+-------------+--------------------+---------------+----------------------+</span><br><span class="line">|10006  |201501120200|24234 |201501120130 |2342                |201501120300   |31232                 |</span><br><span class="line">+-------+------------+------+-------------+--------------------+---------------+----------------------+</span><br></pre></td></tr></table></figure>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">分析：</span><br><span class="line">pyspark.sql.functions.lag(col, count=1, default=none)</span><br><span class="line">是取前N行的值</span><br><span class="line"></span><br><span class="line">pyspark.sql.functions.lead(col, count=1, default=none)</span><br><span class="line">是取后N行的值。</span><br></pre></td></tr></table></figure>
<p>4.按照销售金额进行排名，金额最大的排最前（limit可以取topn的数）</p>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line">df.withColumn(</span><br><span class="line">    <span class="string">'rn'</span>,</span><br><span class="line">    dense_rank().over(Window.partitionBy(<span class="string">'shop_id'</span>).orderBy(desc(<span class="string">'amount'</span>)))</span><br><span class="line">).select(</span><br><span class="line">    <span class="string">'shop_id'</span>, <span class="string">'date'</span>, <span class="string">'amount'</span>, <span class="string">'rn'</span>    </span><br><span class="line">).show(<span class="number">50</span>, truncate=<span class="literal">False</span>)</span><br></pre></td></tr></table></figure>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">+-------+------------+-------+---+</span><br><span class="line">|shop_id|date        |amount |rn |</span><br><span class="line">+-------+------------+-------+---+</span><br><span class="line">|10006  |201501120800|5645622|1  |</span><br><span class="line">|10006  |201501122100|2344562|2  |</span><br><span class="line">|10006  |201501121430|652562 |3  |</span><br><span class="line">|10006  |201501121230|534236 |4  |</span><br><span class="line">|10006  |201501120700|425432 |5  |</span><br><span class="line">|10006  |201501120900|366642 |6  |</span><br><span class="line">|10006  |201501121330|353462 |7  |</span><br><span class="line">|10006  |201501121200|254352 |8  |</span><br><span class="line">|10006  |201501122230|242546 |9  |</span><br><span class="line">|10006  |201501122030|242443 |10 |</span><br><span class="line">|10006  |201501120600|231635 |11 |</span><br><span class="line">|10006  |201501120330|221313 |12 |</span><br><span class="line">|10006  |201501120930|74632  |13 |</span><br><span class="line">|10006  |201501121900|65642  |14 |</span><br><span class="line">|10006  |201501121400|64562  |15 |</span><br><span class="line">|10006  |201501121000|63562  |16 |</span><br><span class="line">|10006  |201501130000|45245  |17 |</span><br><span class="line">|10006  |201501120730|36362  |18 |</span><br><span class="line">|10006  |201501121300|35432  |19 |</span><br><span class="line">|10006  |201501120830|34532  |20 |</span><br><span class="line">|10006  |201501120300|31232  |21 |</span><br><span class="line">|10006  |201501121630|27843  |22 |</span><br><span class="line">|10006  |201501121030|26353  |23 |</span><br><span class="line">|10006  |201501121130|26352  |24 |</span><br><span class="line">|10006  |201501122000|25376  |25 |</span><br><span class="line">|10006  |201501121730|24683  |26 |</span><br><span class="line">|10006  |201501120200|24234  |27 |</span><br><span class="line">|10006  |201501120100|23112  |28 |</span><br><span class="line">|10006  |201501120130|23112  |28 |</span><br><span class="line">|10006  |201501122300|6542   |29 |</span><br><span class="line">|10006  |201501121530|6422   |30 |</span><br><span class="line">|10006  |201501122130|5462   |31 |</span><br><span class="line">|10006  |201501121830|5342   |32 |</span><br><span class="line">|10006  |201501121800|4532   |33 |</span><br><span class="line">|10006  |201501122330|2546   |34 |</span><br><span class="line">|10006  |201501120630|2536   |35 |</span><br><span class="line">|10006  |201501122200|2535   |36 |</span><br><span class="line">|10006  |201501121930|2534   |37 |</span><br><span class="line">|10006  |201501121500|2456   |38 |</span><br><span class="line">|10006  |201501121700|2362   |39 |</span><br><span class="line">|10006  |201501121100|2353   |40 |</span><br><span class="line">|10006  |201501120030|2313   |41 |</span><br><span class="line">|10006  |201501120500|2234   |42 |</span><br><span class="line">|10006  |201501120530|2234   |42 |</span><br><span class="line">|10006  |201501120430|2231   |43 |</span><br><span class="line">|10006  |201501120400|2134   |44 |</span><br><span class="line">|10006  |201501121600|422    |45 |</span><br><span class="line">|10006  |201501120230|132    |46 |</span><br><span class="line">+-------+------------+-------+---+</span><br></pre></td></tr></table></figure>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line">df.withColumn(</span><br><span class="line">    <span class="string">'rn'</span>,</span><br><span class="line">    rank().over(Window.partitionBy(<span class="string">'shop_id'</span>).orderBy(desc(<span class="string">'amount'</span>)))</span><br><span class="line">).select(</span><br><span class="line">    <span class="string">'shop_id'</span>, <span class="string">'date'</span>, <span class="string">'amount'</span>, <span class="string">'rn'</span>    </span><br><span class="line">).show(<span class="number">50</span>, truncate=<span class="literal">False</span>)</span><br></pre></td></tr></table></figure>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">+-------+------------+-------+---+</span><br><span class="line">|shop_id|date        |amount |rn |</span><br><span class="line">+-------+------------+-------+---+</span><br><span class="line">|10006  |201501120800|5645622|1  |</span><br><span class="line">|10006  |201501122100|2344562|2  |</span><br><span class="line">|10006  |201501121430|652562 |3  |</span><br><span class="line">|10006  |201501121230|534236 |4  |</span><br><span class="line">|10006  |201501120700|425432 |5  |</span><br><span class="line">|10006  |201501120900|366642 |6  |</span><br><span class="line">|10006  |201501121330|353462 |7  |</span><br><span class="line">|10006  |201501121200|254352 |8  |</span><br><span class="line">|10006  |201501122230|242546 |9  |</span><br><span class="line">|10006  |201501122030|242443 |10 |</span><br><span class="line">|10006  |201501120600|231635 |11 |</span><br><span class="line">|10006  |201501120330|221313 |12 |</span><br><span class="line">|10006  |201501120930|74632  |13 |</span><br><span class="line">|10006  |201501121900|65642  |14 |</span><br><span class="line">|10006  |201501121400|64562  |15 |</span><br><span class="line">|10006  |201501121000|63562  |16 |</span><br><span class="line">|10006  |201501130000|45245  |17 |</span><br><span class="line">|10006  |201501120730|36362  |18 |</span><br><span class="line">|10006  |201501121300|35432  |19 |</span><br><span class="line">|10006  |201501120830|34532  |20 |</span><br><span class="line">|10006  |201501120300|31232  |21 |</span><br><span class="line">|10006  |201501121630|27843  |22 |</span><br><span class="line">|10006  |201501121030|26353  |23 |</span><br><span class="line">|10006  |201501121130|26352  |24 |</span><br><span class="line">|10006  |201501122000|25376  |25 |</span><br><span class="line">|10006  |201501121730|24683  |26 |</span><br><span class="line">|10006  |201501120200|24234  |27 |</span><br><span class="line">|10006  |201501120100|23112  |28 |</span><br><span class="line">|10006  |201501120130|23112  |28 |</span><br><span class="line">|10006  |201501122300|6542   |30 |</span><br><span class="line">|10006  |201501121530|6422   |31 |</span><br><span class="line">|10006  |201501122130|5462   |32 |</span><br><span class="line">|10006  |201501121830|5342   |33 |</span><br><span class="line">|10006  |201501121800|4532   |34 |</span><br><span class="line">|10006  |201501122330|2546   |35 |</span><br><span class="line">|10006  |201501120630|2536   |36 |</span><br><span class="line">|10006  |201501122200|2535   |37 |</span><br><span class="line">|10006  |201501121930|2534   |38 |</span><br><span class="line">|10006  |201501121500|2456   |39 |</span><br><span class="line">|10006  |201501121700|2362   |40 |</span><br><span class="line">|10006  |201501121100|2353   |41 |</span><br><span class="line">|10006  |201501120030|2313   |42 |</span><br><span class="line">|10006  |201501120500|2234   |43 |</span><br><span class="line">|10006  |201501120530|2234   |43 |</span><br><span class="line">|10006  |201501120430|2231   |45 |</span><br><span class="line">|10006  |201501120400|2134   |46 |</span><br><span class="line">|10006  |201501121600|422    |47 |</span><br><span class="line">|10006  |201501120230|132    |48 |</span><br><span class="line">+-------+------------+-------+---+</span><br></pre></td></tr></table></figure>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line">df.withColumn(</span><br><span class="line">    <span class="string">'rn'</span>,</span><br><span class="line">    row_number().over(Window.partitionBy(<span class="string">'shop_id'</span>).orderBy(desc(<span class="string">'amount'</span>)))</span><br><span class="line">).select(</span><br><span class="line">    <span class="string">'shop_id'</span>, <span class="string">'date'</span>, <span class="string">'amount'</span>, <span class="string">'rn'</span>    </span><br><span class="line">).show(<span class="number">50</span>, truncate=<span class="literal">False</span>)</span><br></pre></td></tr></table></figure>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">+-------+------------+-------+---+</span><br><span class="line">|shop_id|date        |amount |rn |</span><br><span class="line">+-------+------------+-------+---+</span><br><span class="line">|10006  |201501120800|5645622|1  |</span><br><span class="line">|10006  |201501122100|2344562|2  |</span><br><span class="line">|10006  |201501121430|652562 |3  |</span><br><span class="line">|10006  |201501121230|534236 |4  |</span><br><span class="line">|10006  |201501120700|425432 |5  |</span><br><span class="line">|10006  |201501120900|366642 |6  |</span><br><span class="line">|10006  |201501121330|353462 |7  |</span><br><span class="line">|10006  |201501121200|254352 |8  |</span><br><span class="line">|10006  |201501122230|242546 |9  |</span><br><span class="line">|10006  |201501122030|242443 |10 |</span><br><span class="line">|10006  |201501120600|231635 |11 |</span><br><span class="line">|10006  |201501120330|221313 |12 |</span><br><span class="line">|10006  |201501120930|74632  |13 |</span><br><span class="line">|10006  |201501121900|65642  |14 |</span><br><span class="line">|10006  |201501121400|64562  |15 |</span><br><span class="line">|10006  |201501121000|63562  |16 |</span><br><span class="line">|10006  |201501130000|45245  |17 |</span><br><span class="line">|10006  |201501120730|36362  |18 |</span><br><span class="line">|10006  |201501121300|35432  |19 |</span><br><span class="line">|10006  |201501120830|34532  |20 |</span><br><span class="line">|10006  |201501120300|31232  |21 |</span><br><span class="line">|10006  |201501121630|27843  |22 |</span><br><span class="line">|10006  |201501121030|26353  |23 |</span><br><span class="line">|10006  |201501121130|26352  |24 |</span><br><span class="line">|10006  |201501122000|25376  |25 |</span><br><span class="line">|10006  |201501121730|24683  |26 |</span><br><span class="line">|10006  |201501120200|24234  |27 |</span><br><span class="line">|10006  |201501120100|23112  |28 |</span><br><span class="line">|10006  |201501120130|23112  |29 |</span><br><span class="line">|10006  |201501122300|6542   |30 |</span><br><span class="line">|10006  |201501121530|6422   |31 |</span><br><span class="line">|10006  |201501122130|5462   |32 |</span><br><span class="line">|10006  |201501121830|5342   |33 |</span><br><span class="line">|10006  |201501121800|4532   |34 |</span><br><span class="line">|10006  |201501122330|2546   |35 |</span><br><span class="line">|10006  |201501120630|2536   |36 |</span><br><span class="line">|10006  |201501122200|2535   |37 |</span><br><span class="line">|10006  |201501121930|2534   |38 |</span><br><span class="line">|10006  |201501121500|2456   |39 |</span><br><span class="line">|10006  |201501121700|2362   |40 |</span><br><span class="line">|10006  |201501121100|2353   |41 |</span><br><span class="line">|10006  |201501120030|2313   |42 |</span><br><span class="line">|10006  |201501120500|2234   |43 |</span><br><span class="line">|10006  |201501120530|2234   |44 |</span><br><span class="line">|10006  |201501120430|2231   |45 |</span><br><span class="line">|10006  |201501120400|2134   |46 |</span><br><span class="line">|10006  |201501121600|422    |47 |</span><br><span class="line">|10006  |201501120230|132    |48 |</span><br><span class="line">+-------+------------+-------+---+</span><br></pre></td></tr></table></figure>
<p>分析：<br>dense_rank和rank都是排名函数，区别在于dense_rank是连续排名，rank遇到排名并列时，下一列排名跳空。<br>row_number是加行号，次序是连续的，不会存在重复的行号</p>
<p>5.按销售金额排序，取出前20%的时间段和相应金额</p>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line">df.withColumn(</span><br><span class="line">    <span class="string">'tile'</span>,</span><br><span class="line">    ntile(<span class="number">5</span>).over(Window.partitionBy(<span class="string">'shop_id'</span>).orderBy(desc(<span class="string">'amount'</span>)))</span><br><span class="line">).select(</span><br><span class="line">    <span class="string">'shop_id'</span>, <span class="string">'date'</span>, <span class="string">'amount'</span>, <span class="string">'tile'</span>    </span><br><span class="line">).show(<span class="number">50</span>, truncate=<span class="literal">False</span>)</span><br></pre></td></tr></table></figure>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">+-------+------------+-------+----+</span><br><span class="line">|shop_id|date        |amount |tile|</span><br><span class="line">+-------+------------+-------+----+</span><br><span class="line">|10006  |201501120800|5645622|1   |</span><br><span class="line">|10006  |201501122100|2344562|1   |</span><br><span class="line">|10006  |201501121430|652562 |1   |</span><br><span class="line">|10006  |201501121230|534236 |1   |</span><br><span class="line">|10006  |201501120700|425432 |1   |</span><br><span class="line">|10006  |201501120900|366642 |1   |</span><br><span class="line">|10006  |201501121330|353462 |1   |</span><br><span class="line">|10006  |201501121200|254352 |1   |</span><br><span class="line">|10006  |201501122230|242546 |1   |</span><br><span class="line">|10006  |201501122030|242443 |1   |</span><br><span class="line">|10006  |201501120600|231635 |2   |</span><br><span class="line">|10006  |201501120330|221313 |2   |</span><br><span class="line">|10006  |201501120930|74632  |2   |</span><br><span class="line">|10006  |201501121900|65642  |2   |</span><br><span class="line">|10006  |201501121400|64562  |2   |</span><br><span class="line">|10006  |201501121000|63562  |2   |</span><br><span class="line">|10006  |201501130000|45245  |2   |</span><br><span class="line">|10006  |201501120730|36362  |2   |</span><br><span class="line">|10006  |201501121300|35432  |2   |</span><br><span class="line">|10006  |201501120830|34532  |2   |</span><br><span class="line">|10006  |201501120300|31232  |3   |</span><br><span class="line">|10006  |201501121630|27843  |3   |</span><br><span class="line">|10006  |201501121030|26353  |3   |</span><br><span class="line">|10006  |201501121130|26352  |3   |</span><br><span class="line">|10006  |201501122000|25376  |3   |</span><br><span class="line">|10006  |201501121730|24683  |3   |</span><br><span class="line">|10006  |201501120200|24234  |3   |</span><br><span class="line">|10006  |201501120100|23112  |3   |</span><br><span class="line">|10006  |201501120130|23112  |3   |</span><br><span class="line">|10006  |201501122300|6542   |3   |</span><br><span class="line">|10006  |201501121530|6422   |4   |</span><br><span class="line">|10006  |201501122130|5462   |4   |</span><br><span class="line">|10006  |201501121830|5342   |4   |</span><br><span class="line">|10006  |201501121800|4532   |4   |</span><br><span class="line">|10006  |201501122330|2546   |4   |</span><br><span class="line">|10006  |201501120630|2536   |4   |</span><br><span class="line">|10006  |201501122200|2535   |4   |</span><br><span class="line">|10006  |201501121930|2534   |4   |</span><br><span class="line">|10006  |201501121500|2456   |4   |</span><br><span class="line">|10006  |201501121700|2362   |5   |</span><br><span class="line">|10006  |201501121100|2353   |5   |</span><br><span class="line">|10006  |201501120030|2313   |5   |</span><br><span class="line">|10006  |201501120500|2234   |5   |</span><br><span class="line">|10006  |201501120530|2234   |5   |</span><br><span class="line">|10006  |201501120430|2231   |5   |</span><br><span class="line">|10006  |201501120400|2134   |5   |</span><br><span class="line">|10006  |201501121600|422    |5   |</span><br><span class="line">|10006  |201501120230|132    |5   |</span><br><span class="line">+-------+------------+-------+----+</span><br></pre></td></tr></table></figure>
<p>分析：</p>
<p>NTILE就是把有序分区中的行分发到指定数据的组中，各个组有编号，编号从1开始，对于每一行，NTILE返回此行所属的组的编号</p>
<p>设置n=5，那么ntile就会把排好序的数据均分成n个组，ntile函数会返回每条数据所在组的组编号，从而可以达到取前百分比的数据</p>
<p>思考：在使用row_number函数的时候，并没有指定rowsBetween，那么默认应该是默认的rows between unbounded preceding and current row。<br>但是，结果却是把组内的所有元素都进行了标号</p>
<p>rowsBetween应该是针对于具有聚合性质的函数起作用</p>

        </section>
    </article>
    
        <!-- disqus 评论框 start -->
        <div class="comment">
            <div id="disqus_thread" class="disqus-thread">
              <i>加载评论框需要翻墙</i>
            </div>
        </div>
        <!-- disqus 评论框 end -->
    
        
  </div>
  <aside>
    
  </aside>
</main>

<!-- disqus 公共JS代码 -->
<script type="text/javascript">
  /* * * CONFIGURATION VARIABLES * * */
  var disqus_shortname = "ws-blog";
  var disqus_identifier = "https://shang.at/post/Spark学习笔记-窗口函数/";
  var disqus_url = "https://shang.at/post/Spark学习笔记-窗口函数/";

  isAgent(getDisqus)

  // determine user agent in China
  function isAgent(cb) {
    var url = '//graph.facebook.com/feed?callback=h';
    var xhr = new XMLHttpRequest();
    var called = false;
    xhr.open('GET', url);
    xhr.onreadystatechange = function() {
      if (xhr.readyState === 4 && xhr.status === 200) {
      called = true;
      cb(true);
      }
    };
    xhr.send();
    // timeout 1s, this facebook API is very fast.
    setTimeout(function() {
      if (!called) {
      xhr.abort();
      cb(false)
      }
    }, 1000);
  }

  function getDisqus(isAgent) {
    var dsq = document.createElement('script'); dsq.type = 'text/javascript'; 
    dsq.async = true
    dsq.src = '//' + disqus_shortname + '.disqus.com/embed.js';
    (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq)
  }
</script>
<!-- disqus 公共JS代码 end -->



  <footer>
  <div class="copyright">
    <div>
      &copy; 2020 | Powered by <a href="https://hexo.io" target="_blank">Hexo</a>&nbsp
    </div>
    <div>
      Theme by <a href="https://github.com/lewis-geek/hexo-theme-Aath" target="_blank">Aath</a>
    </div>
  </div>
</footer>


<script src="https://cdn.bootcss.com/jquery/3.2.1/jquery.min.js"></script>
<script src="/lib/in-view.min.js"></script>
<script src="/lib/lodash.min.js"></script>
<script>
  var isDown = true
  var oldY = 0
  inView.offset(50)

  document.body.addEventListener('touchstart', function(){});
  
  window.addEventListener('scroll', _.throttle(e => {
    var currentY = window.scrollY
    if((oldY - currentY) < 0) {
      isDown = true
    } else {
      isDown = false
    }
    oldY = currentY
  }, 250))

  $("article img").each(function() {
      var strA = "<a data-fancybox='gallery' href='" + this.src + "'></a>";
      $(this).wrapAll(strA);
  });

  $('.toc-link').each(function() {
      var href = $(this).attr("href");
      
      inView(href).on('exit', () => {
        if (isDown) {
          handleActive(href)
        }
      })

      inView(href).on('enter', () => {
        if (!isDown) {
          handleActive(href)
        }
      })

      this.onclick = function(e) {
        var pos = $(href).offset().top - 10;
        $("html,body").animate({scrollTop: pos}, 300);
        setTimeout(() => {
          handleActive(href)
        }, 350)
        return false
      }
  })

  function handleActive(href) {
    document.querySelectorAll('.toc-link').forEach(elm => {
      elm.classList.remove('active')
    })
    document.querySelector(".toc [href='"+ href +"']").classList.add('active')
  }
</script>
<script src="/lib/jquery.fancybox.min.js"></script>


<div id="totop" style="position:fixed;bottom:20px;right:50px;cursor: pointer;">
    <a title="返回顶部"><img src="/imgs/scrollup.png" /></a>
</div>
<script src="/js/totop.js"></script>

</body>
</html>
